<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elonet | Python 3 | Formation 3</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#python-3-formation-3">Python 3 Formation 3</a></li>
<li><a href="#introduction-au-web">Introduction au web</a></li>
<li><a href="#flask">1- Flask</a>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#routes">Routes</a></li>
<li><a href="#structure-de-code">Structure de code</a></li>
</ul>
</li>
<li><a href="#templating">2 - Templating</a>
<ul>
<li><a href="#découpage-des-fichiers">Découpage des fichiers</a></li>
<li><a href="#paramètres">Paramètres</a></li>
<li><a href="#boucles">Boucles</a></li>
<li><a href="#conditions">Conditions</a></li>
<li><a href="#fichiers-statiques">Fichiers statiques</a></li>
</ul>
</li>
<li><a href="#configuration">3 - Configuration</a>
<ul>
<li><a href="#usage">Usage</a></li>
</ul>
</li>
<li><a href="#messages-flash">4 - Messages flash</a></li>
<li><a href="#formulaires">5 - Formulaires</a>
<ul>
<li><a href="#installation-">Installation :</a></li>
<li><a href="#usage-1">Usage</a></li>
<li><a href="#récupérer-les-valeurs-dun-formulaire">Récupérer les valeurs d’un formulaire</a></li>
</ul>
</li>
<li><a href="#orm">6 - ORM</a>
<ul>
<li><a href="#sqlalchemy">SQLAlchemy</a></li>
<li><a href="#installation-1">Installation</a></li>
<li><a href="#déclaration">Déclaration</a></li>
<li><a href="#nom-de-table">Nom de table</a></li>
<li><a href="#usage-2">Usage</a></li>
<li><a href="#relations">Relations</a></li>
</ul>
</li>
<li><a href="#authentification">7 - Authentification</a>
<ul>
<li><a href="#installation-2">Installation</a></li>
<li><a href="#modèle">Modèle</a></li>
<li><a href="#loader">Loader</a></li>
<li><a href="#authentification-1">Authentification</a></li>
<li><a href="#déconnexion">Déconnexion</a></li>
<li><a href="#protection-des-routes">Protection des routes</a></li>
</ul>
</li>
<li><a href="#bootstrap">8 - BootStrap</a>
<ul>
<li><a href="#installation-3">Installation</a></li>
<li><a href="#usage-3">Usage</a></li>
<li><a href="#formulaires-1">Formulaires</a></li>
<li><a href="#navbar">Navbar</a></li>
</ul>
</li>
<li><a href="#structure-de-code-1">9 - Structure de code</a>
<ul>
<li><a href="#fichier-de-configuration">Fichier de configuration</a></li>
<li><a href="#usine-à-application">Usine à application</a></li>
</ul>
</li>
<li><a href="#service-rest">10 - Service REST</a>
<ul>
<li><a href="#flask-restplus">Flask RestPlus</a></li>
<li><a href="#swagger">Swagger</a></li>
<li><a href="#postman">Postman</a></li>
<li><a href="#installation-4">Installation</a></li>
<li><a href="#usage-4">Usage</a></li>
<li><a href="#structure-de-code-2">Structure de code</a></li>
<li><a href="#serializers">Serializers</a></li>
<li><a href="#endpoints">Endpoints</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="python-3-formation-3">Python 3 Formation 3</h1>
<p><img src="https://elonet.fr/img/logo.png" alt="Elonet"></p>
<h1 id="introduction-au-web">Introduction au web</h1>
<p>L’une des forces de Python c’est qu’il existe des bibliothèques pour à peu près tout , nous avons vu comment interagir avec nos programmes depuis la console, voyons comment interagir depuis de web.</p>
<p>Le plus simple pour créer une application web en Python est d’utiliser des bibliothèques déjà existantes.<br>
Les plus connus sont Django et Flask.<br>
Django : <a href="https://www.djangoproject.com/">https://www.djangoproject.com/</a><br>
Flask : <a href="http://flask.pocoo.org/">http://flask.pocoo.org/</a></p>
<p>La différence entre Djanog et Flask se situe dans les capacités présentes de base dans les bibliothèques, Django est très complet tandis que Flask fournit le minimum.</p>
<p>Nous allons étudier Flask, l’avantage de Flask est que la courbe de progression est plus douce que celle de Django et qu’il possède une syntaxe très lisible.</p>
<p>Exemple d’une application affichant Hello World à l’adresse <a href="http://localhost:5552">http://localhost:5552</a>:</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Hello World!"</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  
    <span class="token keyword">import</span> os  
    HOST <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_HOST'</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span>  
    <span class="token keyword">try</span><span class="token punctuation">:</span>  
        PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_PORT'</span><span class="token punctuation">,</span> <span class="token string">'5552'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>  
        PORT <span class="token operator">=</span> <span class="token number">5552</span>  
  
  app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># On Windows  </span>
  <span class="token comment">#app.run(HOST, PORT, debug=True, processes=3) # On Linux </span>
  <span class="token comment">#app.run('0.0.0.0', 8000, processes=3) # On docker</span>
</code></pre>
<h1 id="flask">1- Flask</h1>
<p>Flask est une bibliothèque de type micro framework, c’est-à-dire qu’elle contient le strict minimum pour réaliser une application web, si nous souhaitons plus de fonctionnalités, il est possible d’installer des extensions.</p>
<p>Cette approche permet de créer des applications web légères et souples.</p>
<h2 id="installation">Installation</h2>
<p>Pour installer Flask il suffit d’utiliser <code>pip</code></p>
<pre><code>pip install flask
</code></pre>
<h2 id="routes">Routes</h2>
<p>Flask repose sur la notion de route, à chaque route correspond une fonction.<br>
Pour lier une fonction à une route, il suffit d’utiliser un décorateur <code>@app.route</code></p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"Hello World!"</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/toto"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">toto</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">"toto"</span>
</code></pre>
<p><code>@app.route</code><br>
permet de définir le comportement de l’application quand la route est appelée depuis le web.<br>
Il est possible de créer des routes avec des paramètres à l’aide <code>&lt;</code>, <code>&gt;</code> et en ajoutant le paramètre dans la fonction</p>
<pre class=" language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/books/&lt;book_id&gt;'</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">book</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> <span class="token string">"Book #"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span>
</code></pre>
<p>Ici nous avons défini un paramètre <code>book_id</code>.<br>
Par défaut les paramètres sont des strings.<br>
Il est possible de spécifier le type de paramètre attendu, exemple un int</p>
<pre class=" language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/books/&lt;int:book_id&gt;'</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">book</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> <span class="token string">"Book #"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>book_id<span class="token punctuation">)</span>
</code></pre>
<h2 id="structure-de-code">Structure de code</h2>
<p>La structure de code d’une application est relativement libre du moment que l’on respecte les règles d’import de Python, cependant une bonne structure apporte plus de lisibilité et permet une meilleure évolution de l’application.</p>
<p>Voici une bonne structure pour commencer :</p>
<pre><code>app
  __init__.py
  routes.py
runserver.py
</code></pre>
<p>Le dossier app contient l’ensemble de notre application, il est composé de 2 fichiers :</p>
<ul>
<li><code>__init__.py</code> contient notre application</li>
<li><code>routes.py</code> contient les fonctions correspondants aux routes</li>
</ul>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
  
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>  
  
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes
</code></pre>
<p>fichier <code>app/routes.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> app <span class="token keyword">import</span> app  
  
  
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> <span class="token string">"Hello World!"</span>
</code></pre>
<p>Le fichier <code>runserver.py</code> permets de lancer notre serveur de développement :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> app <span class="token keyword">import</span> app  
  
  
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  
    <span class="token keyword">import</span> os  
    HOST <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_HOST'</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span>  
    <span class="token keyword">try</span><span class="token punctuation">:</span>  
        PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_PORT'</span><span class="token punctuation">,</span> <span class="token string">'5552'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>  
        PORT <span class="token operator">=</span> <span class="token number">5552</span>  
  
  app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># On Windows  </span>
  <span class="token comment">#app.run(HOST, PORT, debug=True, processes=3) # On Linux </span>
  <span class="token comment">#app.run('0.0.0.0', 8000, processes=3) # On docker</span>
</code></pre>
<p>En  lançant le fichier <code>runserver.py</code> nous pouvons accéder à notre service à l’adresse <code>http://localhost:5552</code></p>
<h1 id="templating">2 - Templating</h1>
<p>Flask possède un puissant moteur de template nommé Jinja2, celui-ci nous permet de générer des pages HTML paramétrables.</p>
<p>Créons un dossier <code>templates</code> dans le dossier <code>app</code>, Flask ira directement chercher les templates dans ce dossier.</p>
<p>Prenons une page simple page HTML affichant un message:</p>
<p>Fichier <code>app/templates/hello.html</code></p>
<pre class=" language-html"><code class="prism  language-html"><span class="token doctype">&lt;!doctype html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fr<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Hello {{ name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Nous indiquons que nous attendons un paramètre <code>name</code> à l’aide des doubles moustaches <code>{{</code>…<code>}}</code></p>
<p>Nous allons ensuite générer la page web à l’aide de la méthode <code>render_template</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template  
<span class="token keyword">from</span> app <span class="token keyword">import</span> app  
  
  
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'hello.html'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Toto'</span><span class="token punctuation">)</span> <span class="token comment"># On fournit le paramètre name</span>
</code></pre>
<h2 id="découpage-des-fichiers">Découpage des fichiers</h2>
<p>Le moteur de template Jinja2 nous permet de découper notre page en plusieurs fichiers et d’étendre des pages HTML.</p>
<p>Cela nous permet par exemple d’éviter de recopier le corps de la page à chaque nouvelle page HTML créée.</p>
<p>Pour réaliser cela, créons un fichier <code>base.html</code> qui contiendra un élément <code>content</code> destiné à afficher le reste de notre page web.</p>
<p>Pour définir un bloc la syntaxe est <code>{% block &lt;block_name&gt; %}{% endblock %}</code>.</p>
<p>Fichier <code>app/templates/base.html</code></p>
<pre class=" language-html"><code class="prism  language-html"><span class="token doctype">&lt;!doctype html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fr<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% block content %}{% endblock %}
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Créons maintenant un fichier <code>home.html</code> qui contiendra la page d’accueil.</p>
<p>Pour cela nous allons redéfinir le bloc <code>content</code> de la page <code>base.html</code><br>
Pour étendre une page, la syntaxe est <code>{% extends "&lt;name&gt;.html" %}</code>.</p>
<p>Fichier <code>app/templates/home.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Home page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Appelons maintenant notre page dans le fichier <code>routes.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template  
<span class="token keyword">from</span> app <span class="token keyword">import</span> app  
  
  
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>  
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>  
        <span class="token string">'home.html'</span><span class="token punctuation">,</span>  
        title<span class="token operator">=</span><span class="token string">'Home'</span>
  <span class="token punctuation">)</span>
</code></pre>
<h2 id="paramètres">Paramètres</h2>
<p>Nous avons vu comment passer des types de variables simples à une page HTML, mais il est  possible des passer n’importe quel type de variable en paramètres.</p>
<p>Exemple pour un objet et un dictionnaire dans un fichier <code>users.html</code> :</p>
<p>Fichier <code>app/templates/users.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{ user1['name'] }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{ user2.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template
<span class="token keyword">from</span> app <span class="token keyword">import</span> app

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">'users.html'</span><span class="token punctuation">,</span>
        title<span class="token operator">=</span><span class="token string">'Users'</span><span class="token punctuation">,</span>
        user1<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token string">'Will'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        user2<span class="token operator">=</span>User<span class="token punctuation">(</span><span class="token string">'Dustin'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre>
<h2 id="boucles">Boucles</h2>
<p>Le moteur Jinja2 nous permet de réaliser des boucles sur des objets itérables tels que les listes.</p>
<p>La syntaxe pour réaliser une boucle est : <code>{% for &lt;var_name&gt; in &lt;parameter&gt; %} .... {% endfor %}</code>, le code HTML contenu à l’intérieur du bloc sera répété autant de fois qu’il y a d’élément dans la variable.</p>
<p>Reprenons notre exemple <code>users.html</code> et insérons une boucle pour afficher une liste d’utilisateurs :</p>
<p>Fichier <code>app/templates/users.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {% for user in users %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{ user.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
    {% endfor %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Modifions notre fichier <code>routes.py</code> afin de fournir une liste d’utilisateur :</p>
<pre class=" language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">'users.html'</span><span class="token punctuation">,</span>
        title<span class="token operator">=</span><span class="token string">'Users'</span><span class="token punctuation">,</span>
        users<span class="token operator">=</span><span class="token punctuation">[</span>User<span class="token punctuation">(</span><span class="token string">'Will'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">(</span><span class="token string">'Dustin'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               User<span class="token punctuation">(</span><span class="token string">'Mike'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">(</span><span class="token string">'Hooper'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               User<span class="token punctuation">(</span><span class="token string">'Whopper'</span><span class="token punctuation">)</span>
               <span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
</code></pre>
<h2 id="conditions">Conditions</h2>
<p>Il est aussi possible de réaliser des conditions dans nos pages HTML à l’aide de la syntaxe :</p>
<pre class=" language-html"><code class="prism  language-html">{% if <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span><span class="token punctuation">&gt;</span></span> %}
{% elif <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>condition</span><span class="token punctuation">&gt;</span></span> %}
{% else %}
{% endif %}
</code></pre>
<p>Reprenons notre fichier <code>users.html</code> et ajoutons une erreur si le paramètre <code>users</code> n’est pas fourni :</p>
<p>Fichier <code>app/templates/users.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {% if users %}
        {% for user in users %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>{{ user.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        {% endfor %}
    
    {% else %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>Alert ! Users is None<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
    
    {% endif %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Essayez de ne plus fournis le paramètre <code>users</code> dans le fichier <code>routes.py</code>, la page web affichera une alerte <code>Alert ! Users is None</code>.</p>
<p>Les conditions nous permettent par exemple d’afficher des éléments uniquement si l’utilisateur est connecté.</p>
<h2 id="fichiers-statiques">Fichiers statiques</h2>
<p>En général qui dit application web dit feuille de style et scripts, par défaut Flask va chercher les fichiers statiques dans le dossier <code>static</code> de votre application, en interne Flask possède une fonction pour gérer les fichiers statiques.</p>
<p>Créons un dossier <code>static</code> dans le dossier <code>app</code> et ajoutons un fichier <code>default.css</code></p>
<p>Fichier <code>app/static/default.css</code></p>
<pre class=" language-css"><code class="prism  language-css"><span class="token selector">h1 </span><span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> green<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Modifions maintenant notre fichier <code>base.html</code> pour inclure cette nouvelle feuille de style.</p>
<p>Pour avoir l’URL de notre fichier, nous allons utiliser <code>url_for</code> qui permet d’avoir la route d’une fonction, ici nous souhaitons accéder à la fonction de gestion des fichiers statiques.</p>
<p>Profitons-en pour créer un bloc <code>style</code> qui contient nos feuilles de style, de cette manière nous pourrons étendre le bloc dans des pages enfantes en utilisant <code>{{ super() }}</code>.</p>
<p>Fichier <code>app/templates/base.html</code></p>
<pre class=" language-html"><code class="prism  language-html"><span class="token doctype">&lt;!doctype html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fr<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    {% block style %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>default.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% block content %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Nous pouvons même créer un système de thème à l’aide des conditions, créons un fichier <code>blue.css</code> et <code>red.css</code></p>
<p>Fichier <code>app/static/blue.css</code></p>
<pre class=" language-css"><code class="prism  language-css"><span class="token selector">h1 </span><span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> blue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Fichier <code>app/static/red.css</code></p>
<pre class=" language-css"><code class="prism  language-css"><span class="token selector">h1 </span><span class="token punctuation">{</span>
    <span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Modifions de nouveau notre fichier <code>base.html</code></p>
<p>Fichier <code>app/templates/base.html</code></p>
<pre class=" language-html"><code class="prism  language-html"><span class="token doctype">&lt;!doctype html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fr<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>{{ title }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
    {% block style %}
    {% if theme == 'blue' %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>blue.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% elif theme == 'red' %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>red.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% else %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/css<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>default.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    {% endif %}
    {% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    {% block content %}{% endblock %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<p>Nous pouvons désormais fournir un paramètre thème dans notre fichier <code>routes.py</code></p>
<pre class=" language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">'home.html'</span><span class="token punctuation">,</span>
        title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">,</span>
        theme<span class="token operator">=</span><span class="token string">'red'</span>
    <span class="token punctuation">)</span>
</code></pre>
<h1 id="configuration">3 - Configuration</h1>
<p>Chaque application Flask possède une configuration qu’il est possible de lire ou de modifier, certainnes fonctions ou extensions nécessites d’ajouter une valeur à la configuration.</p>
<h2 id="usage">Usage</h2>
<p>Pour modifier la configuration de notre application, il faut modifier le dictionnaire <code>config</code> de notre objet <code>app</code></p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
  
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'MY_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'ma_valeur'</span> 
  
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes
</code></pre>
<h1 id="messages-flash">4 - Messages flash</h1>
<p>Les messages flash sont un moyen de stocker des messages qui seront accessibles une seule fois, ils sont pratiques, car ils peuvent être utilisés d’une page à l’autre.</p>
<p>L’utilisation des messages flash nécessite que la valeur <code>SECRET_KEY</code> soit définie dans notre application</p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
  
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'my_secret_key'</span>
  
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes
</code></pre>
<p>Pour ajouter un message flash, il suffit d’utiliser la fonction <code>flash</code> qui prend en paramètre le message à stocker.</p>
<p>Nous pouvons ensuite récupérer les messages flash à l’aide de la fonction <code>get_flashed_messages()</code></p>
<p>Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> redirect
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    flash<span class="token punctuation">(</span><span class="token string">'Redirection depuis index'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">home</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'home.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">)</span>
</code></pre>
<p>Fichier <code>app/templates/home.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {% for message in messages %}
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>{{ message }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
        {% endfor %}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
      {% endif %}
    {% endwith %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Le mot clé <code>with</code> permet de créer un bloc et de limiter la portée des variables, ainsi <code>messages</code> et uniquement disponible dans le bloc <code>{% with ... %}{% endwith %}</code></p>
<h1 id="formulaires">5 - Formulaires</h1>
<p>Pour gérer les formulaires de manière simple, nous allons ajouter l’extension <code>flask-wtf</code>.</p>
<p>Cette extension nous permet de traiter les formulaires sous forme d’objet et d’ajouter des règles de validation de données pour les champs du formulaire.</p>
<h2 id="installation-">Installation :</h2>
<pre><code>pip install flask-wtf
</code></pre>
<p>Pour fonctionner, <code>flask-wtf</code> nécessite que la valeur <code>SECRET_KEY</code> soit définie dans notre application</p>
<h2 id="usage-1">Usage</h2>
<p><code>flask-wtf</code> nous permet de considérer les formulaires comme des objets, pour cela il suffit d’étendre l’objet <code>FlaskForm</code> présent dans <code>flask-wtf</code>.</p>
<p>Chaque attribut de l’objet représente un champ du formulaire, et chaque attribut possède un type de champ.</p>
<p>Le choix des champs est important, car <code>flask-wtf</code> va générer le code HTML du champ.</p>
<p>Nous pouvons définir des règles de validation des champs, il suffit de spécifier le paramètre <code>validators</code> qui attend un tableau de règles de validation, ici <code>DataRequired</code></p>
<p>Créons un fichier <code>forms.py</code> qui contient un formulaire d’authentification.<br>
Le formulaire contient :</p>
<ul>
<li>Un champ texte obligatoire pour le nom d’utilisateur</li>
<li>Un champ obligatoire pour le mot de passe</li>
<li>Un bouton permettant de valider le formulaire</li>
</ul>
<p>Fichier <code>app/forms.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_wtf <span class="token keyword">import</span> FlaskForm
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> StringField<span class="token punctuation">,</span> PasswordField<span class="token punctuation">,</span> SubmitField
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>validators <span class="token keyword">import</span> DataRequired

<span class="token keyword">class</span> <span class="token class-name">LoginForm</span><span class="token punctuation">(</span>FlaskForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    username <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">'Nom d\'utilisateur'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> PasswordField<span class="token punctuation">(</span><span class="token string">'Mot de passe'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    submit <span class="token operator">=</span> SubmitField<span class="token punctuation">(</span><span class="token string">'Connexion'</span><span class="token punctuation">)</span>
</code></pre>
<p>Créons une page <code>login.html</code> qui hérite de la page <code>base.html</code> et qui contient notre page d’authentification.</p>
<p>Cette page prend en paramètre un formulaire à afficher.</p>
<p>Fichier <code>app/templates/login.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "base.html" %}
{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Authentification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {{ form.hidden_tag() }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            {{ form.username.label }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
            {{ form.username(size=8) }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            {{ form.password.label }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
            {{ form.password(size=8) }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
            {{ form.submit() }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Appelons maintenant notre fichier <code>login.html</code> dans le fichier <code>routes.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">'login.html'</span><span class="token punctuation">,</span>
        title<span class="token operator">=</span><span class="token string">'Authentification'</span><span class="token punctuation">,</span>
        form<span class="token operator">=</span>form
    <span class="token punctuation">)</span>
</code></pre>
<p>Si nous lançons notre service, nous avons bien notre page d’authentification accessible via la route <code>/login</code>.</p>
<h2 id="récupérer-les-valeurs-dun-formulaire">Récupérer les valeurs d’un formulaire</h2>
<p>La récupération de valeurs d’un formulaire est une tache très simple à l’aide de <code>flask-wtf</code>, il suffit d’utiliser la méthode <code>validate_on_submit()</code> de l’objet formulaire.</p>
<p>Si le formulaire contient des règles de validation et que celles-ci ne sont pas satisfaites, <code>flask-wtf</code> ne considérera pas le formulaire comme valide.</p>
<p>Pour récupérer les valeurs d’un formulaire, il faut ajouter la méthode POST à notre route.</p>
<p>Le décorateur <code>@app.route</code> peux définir une route (unique exemple vue jusque ici) mais aussi les méthodes HTTP que nous acceptons de traiter ou non, par défaut une route accepte uniquement la méthode HTTP <code>GET</code></p>
<p>Pour accepter plus de méthodes, il faut ajouter <code>methods=[]</code> au décorateur.</p>
<p>Si le formulaire est valide, nous redirigeons l’utilisateur sur la page d’accueil de notre service, sinon nous affichons de nouveau le formulaire.</p>
<pre class=" language-python"><code class="prism  language-python">@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{0} : {1}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">,</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Affichage pour debug</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Sign In'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
</code></pre>
<p>A l’aide de <code>DataRequired</code> nous sommes sûrs de récupérer un nom d’utilisateur et un mot de passe, charge à nous de vérifier si l’utilisateur existe.</p>
<h1 id="orm">6 - ORM</h1>
<p>Les ORM sont des bibliothèques de mapping objet-relationnel qui nous permettent de “stocker” des objets Python dans nos bases de données.</p>
<p>En respectant une syntaxe propre à chaque ORM, nous n’avons plus besoin d’écrire du langage de base de données pour accéder à nos données.</p>
<h2 id="sqlalchemy">SQLAlchemy</h2>
<p>SQLAlchemy est la bibliothèque ORM de référence en Python pour interagir avec une base SQL, elle gère toutes les bases de données de type SQL (ou presque toutes)</p>
<p>La version Flask de la bibliothèque s’appelle <code>flask-sqlalchemy</code></p>
<h2 id="installation-1">Installation</h2>
<pre><code>pip install flask-slqalchemy
</code></pre>
<p><code>flask-sqlalchemy</code> nécessite 2 configurations supplémentaires :</p>
<ul>
<li><code>SQLALCHEMY_DATABASE_URI</code> qui est l’URI de la base de données</li>
<li><code>SQLALCHEMY_TRACK_MODIFICATIONS</code> qui permet de rendre <code>flask-sqlalchemy</code> moins verbeux et plus rapide</li>
</ul>
<p>Exemple pour une base de données SQLite <code>app.db</code> contenue dans notre dossier <code>app</code></p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
db_uri <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'app.db'</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'my_secret_key'</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> db_uri
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_TRACK_MODIFICATIONS'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes
</code></pre>
<p>Il faut ensuite créer un objet <code>SQLAlchemy</code> qui prend en paramètre notre application Flask</p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
db_uri <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'app.db'</span><span class="token punctuation">)</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'my_secret_key'</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_DATABASE_URI'</span><span class="token punctuation">]</span> <span class="token operator">=</span> db_uri
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SQLALCHEMY_TRACK_MODIFICATIONS'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes
</code></pre>
<h2 id="déclaration">Déclaration</h2>
<p><code>flask-sqlalchemy</code> nous permet de “stocker” nos objets en base de données, pour cela il suffit d’étendre la classe <code>Model</code> présent dans <code>SQLAlchemy</code>.</p>
<p>Chaque objet représente une table de la base et chaque attribut représente une colonne.</p>
<p>Chaque colonne contient un type de données défini, il est possible d’ajouter des contrôles tels que <code>primary_key</code>, <code>nullable</code>, <code>index</code>, <code>unique</code>, <code>default</code>, etc …</p>
<p>Créons un fichier <code>models.py</code> qui contient un objet représentant un utilisateur du système.</p>
<p>Fichier <code>app/models.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> app <span class="token keyword">import</span> db

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Représente un utilisateur
    """</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password_hash <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>Pour créer notre base à partir de notre code, il existe plusieurs solutions telles que <code>flask-migrate</code> qui génère des scripts de migration à partir de nos objets, ici nous allons utiliser une méthode plus simple et laisser <code>SQLAlchemy</code> créer notre base.</p>
<p>Pour cela il faut importer l’ensemble des objets du modèle et utiliser la méthode <code>create_all</code></p>
<p>Ficier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
  
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> routes  
  
<span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> User  
  
db<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Ainsi notre base de données sera créée au démarrage de l’application si elle n’existe pas.</p>
<p>L’inconvénient de cette méthode est que si un objet de l’ORM est modifié, il faut supprimer la base de données.</p>
<h2 id="nom-de-table">Nom de table</h2>
<p>SQLAlchemy utilise le nom de notre objet pour créer un nom de table, ainsi la classe <code>User</code> donne le nom de table <code>user</code>.</p>
<p>Cela est très pratique la plupart du temps, mais peut poser certains problèmes dans le cas de nom d’objet contenant plusieurs majuscules, par exemple <code>MasterChiefWeapon</code> donne le nom de table <code>master_chief_weapon</code>.</p>
<p>En soi, ce n’est pas un problème de mettre un underscore à chaque majuscule, mais il faut s’en souvenir lors d’ajout de clés étrangères.</p>
<p>Il est possible de définir nous-mêmes le nom de la table dans laquelle seront stockés nos objets à l’aide de l’attribut <code>__tablename__</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'users'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password_hash <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="usage-2">Usage</h2>
<p>Testons notre classe <code>User</code>, pour cela plaçons notre terminal dans le dossier de notre application et lançon Python 3</p>
<p>De la importons notre classe <code>User</code> et l’objet <code>db</code> depuis le module <code>models</code> (voir la formation 1 pour la notion de module / package).</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token punctuation">(</span>venv<span class="token punctuation">)</span> <span class="token operator">&gt;</span>python
Python <span class="token number">3.5</span><span class="token punctuation">.</span><span class="token number">4</span> <span class="token punctuation">(</span>v3<span class="token number">.5</span><span class="token punctuation">.</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">3f56838</span><span class="token punctuation">,</span> Aug  <span class="token number">8</span> <span class="token number">2017</span><span class="token punctuation">,</span> <span class="token number">02</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">05</span><span class="token punctuation">)</span> <span class="token punctuation">[</span>MSC v<span class="token number">.1900</span> <span class="token number">64</span> bit <span class="token punctuation">(</span>AMD64<span class="token punctuation">)</span><span class="token punctuation">]</span> on win32
Type <span class="token string">"help"</span><span class="token punctuation">,</span> <span class="token string">"copyright"</span><span class="token punctuation">,</span> <span class="token string">"credits"</span> <span class="token operator">or</span> <span class="token string">"license"</span> <span class="token keyword">for</span> more information<span class="token punctuation">.</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">,</span> db
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="insertion">Insertion</h3>
<p>Pour insérer un utilisateur, il suffit de créer un nouvel objet et de le fournir à l’objet <code>db</code>.</p>
<p>L’objet <code>db</code> contient un objet <code>session</code>, comme en SQL, nos modifications sont enregistrées en base seulement si nous réalisons un <code>commit</code>.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">,</span> db
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Will'</span><span class="token punctuation">,</span> password_hash<span class="token operator">=</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token comment"># Ajout en base</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u<span class="token punctuation">)</span> <span class="token comment"># Ajout dans la session</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># Enregistrement de l'ajout</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span><span class="token builtin">id</span>
<span class="token number">1</span>
</code></pre>
<p>SQLAlchemy à enregistrer notre utilisateur et à modifier l’objet qui possède maintenant un identifiant unique.</p>
<p>Si nous essayons de nouveau d’ajouter un utilisateur nommé <code>Will</code> SQLAlchemy lèvera une exception, car l’attribut <code>username</code> est défini comme unique.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u2 <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Will'</span><span class="token punctuation">,</span> password_hash<span class="token operator">=</span><span class="token string">'super secret'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u2<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"C:\Users\averd\PycharmProjects\py_micro_front\venv\lib\site-packages\sqlalchemy\engine\base.py"</span><span class="token punctuation">,</span> line <span class="token number">1193</span><span class="token punctuation">,</span> <span class="token keyword">in</span> _execute_context
    context<span class="token punctuation">)</span>
  File <span class="token string">"C:\Users\averd\PycharmProjects\py_micro_front\venv\lib\site-packages\sqlalchemy\engine\default.py"</span><span class="token punctuation">,</span> line <span class="token number">507</span><span class="token punctuation">,</span> <span class="token keyword">in</span> do_execute
    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>statement<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span>
sqlite3<span class="token punctuation">.</span>IntegrityError<span class="token punctuation">:</span> UNIQUE constraint failed<span class="token punctuation">:</span> user<span class="token punctuation">.</span>username
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="récupérer-un-objet-à-partir-de-son-identifiant">Récupérer un objet à partir de son identifiant</h3>
<p>Pour récupérer un objet à partir de son identifiant on utilise l’attribut <code>query</code> de l’objet <code>Model</code> (la classe mère de nos objets).</p>
<p>Cet attribut possède une méthode <code>get</code> qui attend la valeur de la clé primaire permettant d’identifier l’objet, en retour elle retourne l’objet si il existe, sinon <code>None</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u
<span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>username
<span class="token string">'Will'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token keyword">is</span> <span class="token boolean">None</span>
<span class="token boolean">True</span>
</code></pre>
<h3 id="récupérer-des-objets">Récupérer des objets</h3>
<p>La recherche d’un objet utilise aussi l’attribut <code>query</code>.</p>
<p>Nous pouvons récupérer l’ensemble des objets à l’aide de <code>all</code> et le premier objet à l’aide de <code>first</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u
<span class="token punctuation">[</span><span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>User <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u
<span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="recherche-dun-objet">Recherche d’un objet</h3>
<p>La recherche d’un objet utilise aussi l’attribut <code>query</code>, cette fois nous utilisons la méthode <code>filter_by</code> qui attend le nom de l’attribut et la valeur recherchée.</p>
<p>Cette méthode retourne un objet de type <code>query</code>, nous pouvons donc récupérer l’ensemble des éléments avec <code>all</code> et le premier avec <code>first</code>.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Will'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u
<span class="token punctuation">[</span><span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Dustion'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u
<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Will'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u
<span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'Dustin'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token keyword">is</span> <span class="token boolean">None</span>
<span class="token boolean">True</span>
</code></pre>
<h3 id="modification-dun-objet">Modification d’un objet</h3>
<p>Pour modifier un objet, il suffit de modifier ses attributs et de l’ajouter de nouveau à notre base de données, SQLAlchemy fait la mise à jour de manière transparente.</p>
<p>Il ne faut pas oublier d’utiliser la méthode <code>commit</code> pour enregistrer les modifications dans la base de données.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>password_hash
<span class="token string">'secret'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>password_hash <span class="token operator">=</span> <span class="token string">'super secret'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u_t <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u_t<span class="token punctuation">.</span>password_hash
<span class="token string">'super secret'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<h3 id="supprimer-un-objet">Supprimer un objet</h3>
<p>Pour supprimer un objet, il suffit de le fournir à notre objet <code>db</code> à l’aide de la méthode <code>delete</code>.</p>
<p>Il ne faut pas oublier d’utiliser la méthode <code>commit</code> pour enregistrer les modifications dans la base de données.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u
<span class="token punctuation">[</span><span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>User <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u
<span class="token operator">&lt;</span>User <span class="token number">1</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> l_u
<span class="token punctuation">[</span><span class="token operator">&lt;</span>User <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
</code></pre>
<h2 id="relations">Relations</h2>
<p>Qui dit base de données relationnelle dit relation, SQLAlchemy nous permet de les définir très facilement. voyons la plus courante, one to many</p>
<h3 id="one-to-many">One to many</h3>
<p>Prenons l’exemple d’un forum, ce forum est composé de topics et chaque topic contient des messages d’utilisateurs.</p>
<p>Concentrons-nous sur la relation topic to messages.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> app <span class="token keyword">import</span> db

<span class="token keyword">class</span> <span class="token class-name">Topic</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    ts <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>
    content <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>Pour ajouter la relation, il faut à la fois modifier la classe <code>Topic</code> et la classe <code>Message</code>.</p>
<p>Dans la classe <code>Message</code> il faut déclarer une clé étrangère à l’aide de <code>ForeignKey</code>, on fournit la table et la colonne.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    ts <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>  
    content <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>  
  
    topic_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'topic.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre>
<p>Dans la classe <code>Topic</code> nous définissons la relation à proprement parler.<br>
Une relation attend au moins 3 paramètres :</p>
<ul>
<li>La classe de l’objet concerné par la relation</li>
<li>Le <code>backref</code>, ce paramètre modifie l’objet concerné par la relation en ajoutant un attribut permettant de remonter la relation</li>
<li>Le <code>lazy</code> qui permet de définir la méthode de chargement des objets de la relation</li>
</ul>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">class</span> <span class="token class-name">Topic</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>  
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    messages <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'Message'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'topic'</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">'dynamic'</span><span class="token punctuation">)</span>
</code></pre>
<p>Nous pouvons maintenant accède à l’ensemble des messages d’un topic à l’aide de l’attribut <code>messages</code> et nous pouvons connaitre le topic d’un message à l’aide de l’attribut <code>topic</code>.</p>
<p>De plus, au lieu de fournir le paramètre <code>topic_id</code> lors de la création d’un <code>Message</code>, nous pouvons simplement passer un objet <code>Topic</code><br>
Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> Topic<span class="token punctuation">,</span> Message<span class="token punctuation">,</span> db
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> t <span class="token operator">=</span> Topic<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'Test'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m1 <span class="token operator">=</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">'Message 1'</span><span class="token punctuation">,</span> topic<span class="token operator">=</span>t<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>m1<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m2 <span class="token operator">=</span> Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">'Message 2'</span><span class="token punctuation">,</span> topic<span class="token operator">=</span>t<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>m2<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>messages
<span class="token operator">&lt;</span>sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>AppenderBaseQuery <span class="token builtin">object</span> at <span class="token number">0x000001CEC597BA20</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> t<span class="token punctuation">.</span>messages<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token operator">&lt;</span>Message <span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>Message <span class="token number">2</span><span class="token operator">&gt;</span><span class="token punctuation">]</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m <span class="token operator">=</span> Message<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>topic
<span class="token operator">&lt;</span>Topic <span class="token number">1</span><span class="token operator">&gt;</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> m<span class="token punctuation">.</span>topic<span class="token punctuation">.</span>name
<span class="token string">'Test'</span>
</code></pre>
<h1 id="authentification">7 - Authentification</h1>
<p>L’extension <code>flask-login</code> nous permet de mettre en place très simplement un système d’authentification utilisateur.</p>
<h2 id="installation-2">Installation</h2>
<pre><code>pip install flask-login
</code></pre>
<p>Il faut ensuite créer un objet <code>LoginManager</code> et lui fournir notre application</p>
<p>Fcihier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
login <span class="token operator">=</span> LoginManager<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre>
<h2 id="modèle">Modèle</h2>
<p><code>flask-login</code> attend un modèle d’utilisateur pour la gestion de l’authentification, pour nous faciliter la vie il nous fournit aussi une classe à étendre pour répondre a ses besoins, la classe <code>UserMixin</code>.</p>
<p>Modifions notre classe utilisateur en héritant de la classe <code>UserMixin</code> et en rendant notre mot de passe sécurisé.</p>
<p>Pour la sécurisation du mot de passe, nous allons utiliser la fonction <code>generate_password_hash</code> présente dans <code>werkzeug.security</code>.<br>
<code>werkzeug</code> est un package installé en même temps que Flask.</p>
<p>Fichier <code>app/models.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> UserMixin
<span class="token keyword">from</span> app <span class="token keyword">import</span> db

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserMixin<span class="token punctuation">,</span> db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password_hash <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>password_hash
    @password<span class="token punctuation">.</span>setter
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>password_hash <span class="token operator">=</span> generate_password_hash<span class="token punctuation">(</span>pwd<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> check_password_hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password_hash<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span>
</code></pre>
<p>Usage :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User<span class="token punctuation">,</span> db
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'will'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>password
<span class="token string">'pbkdf2:sha256:50000$O57zfyTK$2e33221fdb921b865256bfde08d8d85e3ecdc3f1e489e54596a65806ef8b15f6'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>password_hash
<span class="token string">'pbkdf2:sha256:50000$O57zfyTK$2e33221fdb921b865256bfde08d8d85e3ecdc3f1e489e54596a65806ef8b15f6'</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> u<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span><span class="token string">'secret'</span><span class="token punctuation">)</span>
<span class="token boolean">True</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u<span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="loader">Loader</h2>
<p>Il faut ensuite indiquer à <code>flask-login</code> comment charger notre utilisateur, en effet selon la technologie de base de données utilisée (SQL ou NOSQL), la récupération d’un utilisateur diffère.</p>
<p>Pour cela on utilise le décorateur <code>@login.user_loader</code> et on fournit une fonction chargée de récupérer un utilisateur à partir de son identifiant.</p>
<p>Fichier <code>app/models.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> UserMixin
<span class="token keyword">from</span> app <span class="token keyword">import</span> db<span class="token punctuation">,</span> login

@login<span class="token punctuation">.</span>user_loader
<span class="token keyword">def</span> <span class="token function">load_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>UserMixin<span class="token punctuation">,</span> db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    password_hash <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>password_hash
    @password<span class="token punctuation">.</span>setter
    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>password_hash <span class="token operator">=</span> generate_password_hash<span class="token punctuation">(</span>pwd<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">verify_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> check_password_hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>password_hash<span class="token punctuation">,</span> pwd<span class="token punctuation">)</span>
</code></pre>
<h2 id="authentification-1">Authentification</h2>
<p>Nous pouvons maintenant authentifier nos utilisateurs, reprenons notre fichier <code>routes.py</code> et complétons notre route de login.</p>
<p>Nous pouvons connaitre l’utilisateur courant à l’aide de <code>current_user</code> et nous pouvons authentifier un utilisateur à l’aide de <code>login_user</code> tous deux présent dans le package <code>flask_login</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> current_user<span class="token punctuation">,</span> login_user
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash
<span class="token keyword">from</span> app <span class="token keyword">import</span> app
<span class="token keyword">from</span> app<span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_anonymous<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, login please"</span>
    
    <span class="token keyword">return</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> current_user<span class="token punctuation">.</span>username <span class="token operator">+</span> <span class="token string">" !"</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Si déja connecté, redirection vers l'acceuil</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token comment"># Sinon on creer le formulaire</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Si l'utilisateur POST le formulaire</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># On vérifie si l'utilisateur existe</span>
        user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Si le mot de passe n'est pas valide, redirection vers login</span>
        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> <span class="token operator">not</span> user<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Nom d\'utilisateur ou mot de passe incorrect.'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
        
        <span class="token comment"># Sinon on authentifie l'utilisateur</span>
        login_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
        
    <span class="token comment"># Sinon on affiche le formulaire</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Authentification'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
</code></pre>
<h2 id="déconnexion">Déconnexion</h2>
<p>Pour déconnecter un utilisateur, il faut utiliser la fonction <code>logout_user</code> présente dans le package <code>flask_login</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> current_user<span class="token punctuation">,</span> login_user<span class="token punctuation">,</span> logout_user
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash
<span class="token keyword">from</span> app <span class="token keyword">import</span> app
<span class="token keyword">from</span> app<span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logout_user<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="protection-des-routes">Protection des routes</h2>
<p>Si on souhaite que certaines routes soient uniquement accessibles aux utilisateurs connectés, il est possible de les protéger à l’aide du décorateur <code>@login_required</code>.</p>
<p>Pour cela il faut légèrement modifier notre route <code>/login</code> afin que l’utilisateur soit redirigé après le processus de connexion.<br>
Actuellement l’utilisateur est redirigé vers l’index après une connexion.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> current_user<span class="token punctuation">,</span> login_user<span class="token punctuation">,</span> logout_user  
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> request<span class="token punctuation">,</span> url_for  
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url_parse  
<span class="token keyword">from</span> app <span class="token keyword">import</span> app  
<span class="token keyword">from</span> app<span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm  
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Si déja connecté, redirection vers l'acceuil</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    <span class="token comment"># Sinon on créer le formulaire</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># Si l'utilisateur POST le formulaire</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># On vérifie si l'utilisateur existe</span>
        user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># Si le mot de passe n'est pas valide, redirection vers login</span>
        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> <span class="token operator">not</span> user<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Nom d\'utilisateur ou mot de passe incorrect.'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
        <span class="token comment"># Sinon on authentifie l'utilisateur</span>
        login_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token comment"># Redirection si l'utilisateur souhaitait accéder à une route protégée</span>
        next_page <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> next_page <span class="token operator">or</span> url_parse<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span><span class="token punctuation">.</span>netloc <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
            next_page <span class="token operator">=</span> <span class="token string">'/'</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span>
    <span class="token comment"># Sinon on affiche le formulaire</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Authentification'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
</code></pre>
<p>Il faut ensuite indiquer à <code>flask-login</code> la route à utiliser pour effectuer un processus de connexion, pour cela on fournit le nom de la <strong>fonction</strong> qui correspond à la route.</p>
<p>Ici notre fonction s’appelle <code>login</code></p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os  
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy  
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
login <span class="token operator">=</span> LoginManager<span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
login<span class="token punctuation">.</span>login_view <span class="token operator">=</span> <span class="token string">'login'</span>
</code></pre>
<p>Nous pouvons maintenant utiliser notre décorateur <code>@login_required</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> current_user<span class="token punctuation">,</span> login_user<span class="token punctuation">,</span> logout_user<span class="token punctuation">,</span> login_required
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> request
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url_parse
<span class="token keyword">from</span> app <span class="token keyword">import</span> app
<span class="token keyword">from</span> app<span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_anonymous<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"Hello, login please"</span>
    <span class="token keyword">return</span> <span class="token string">"Hello "</span> <span class="token operator">+</span> current_user<span class="token punctuation">.</span>username <span class="token operator">+</span> <span class="token string">" !"</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/me'</span><span class="token punctuation">)</span>
@login_required
<span class="token keyword">def</span> <span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> current_user<span class="token punctuation">.</span>username

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> <span class="token operator">not</span> user<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Nom d\'utilisateur ou mot de passe incorrect.'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
        login_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        next_page <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> next_page <span class="token operator">or</span> url_parse<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span><span class="token punctuation">.</span>netloc <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
            next_page <span class="token operator">=</span> <span class="token string">'/'</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Authentification'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logout_user<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
</code></pre>
<h1 id="bootstrap">8 - BootStrap</h1>
<p>BootStrap est parfait quand il s’agit des créer des applications web un peu jolies en un minimum de temps.</p>
<p>Comme nous l’avons vu, <code>flask-wtf</code> produit lui-même le code HTML des champs de nos formulaires, ce qui peut poser problème avec des frameworks web type BootStrap qui possèdent leurs propres structures de code.</p>
<p>Face à ça 2 solutions :</p>
<ul>
<li>Créer les composants pour Jinja 2 à l’aide des macros (non abordé dans les formations)</li>
<li>Utiliser une bibliothèque le faisant déjà pour nous.</li>
</ul>
<p>Nous allons voir la seconde approche qui permet de rapidement prototyper des applications.</p>
<p>Nous allons utiliser <code>flask-bootstrap</code> qui contient la version 3 de BootStrap</p>
<h2 id="installation-3">Installation</h2>
<pre><code>pip install flask-bootstrap
</code></pre>
<p>Il faut ensuite créer un objet <code>Bootstrap</code> et lui fournir notre application</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os  
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask  
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy  
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager  
<span class="token keyword">from</span> flask_bootstrap <span class="token keyword">import</span> Bootstrap  
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
login <span class="token operator">=</span> LoginManager<span class="token punctuation">(</span>app<span class="token punctuation">)</span>  
Bootstrap<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre>
<h2 id="usage-3">Usage</h2>
<p>L’utilisation du plugin repose sur le moteur Jinja 2, désormais nos pages HTML doivent hérité de <code>bootstrap/base.html</code> à l’aide de <code>{% extends "bootstrap/base.html" %}</code>.</p>
<p>Nous avons ensuite à insérer notre code dans les différents blocs de la page.</p>
<p>Parmi les blocs à notre disposition, nous avons :</p>

<table>
<thead>
<tr>
<th>Bloc</th>
<th>Fonction</th>
</tr>
</thead>
<tbody>
<tr>
<td>title</td>
<td>Contiens le titre</td>
</tr>
<tr>
<td>styles</td>
<td>Contiens les feuilles de style</td>
</tr>
<tr>
<td>navbar</td>
<td>Contiens la navbar</td>
</tr>
<tr>
<td>content</td>
<td>Contiens le contenu de notre page</td>
</tr>
<tr>
<td>scripts</td>
<td>Contiens nos scripts</td>
</tr>
</tbody>
</table><p>Dans le cas des blocs <code>styles</code> et <code>scripts</code>, il est important d’utiliser <code>{{ super() }}</code> afin de ne pas perdre les lignes présentes dans les blocs parents</p>
<h2 id="formulaires-1">Formulaires</h2>
<p>Comme indiqué précédemment, BootStrap possède sa propre structure de code pour les champs de formulaire, <code>flask-bootstrap</code> nous permet d’importer une feuille de macro qui s’occupera d’afficher le champ.</p>
<p>Pour cela il faut ajouter <code>{% import "bootstrap/wtf.html" as wtf %}</code><br>
Exemple pour la page <code>login.html</code> :</p>
<pre class=" language-html"><code class="prism  language-html">{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>Authentification<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form form-horizontal<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {{ form.hidden_tag() }}
        {{ wtf.form_field(form.username) }}
        {{ wtf.form_field(form.password) }}
        {{ wtf.form_field(form.submit) }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<p>Désormais nous affichons nos champs à l’aide de la macro <code>form_field</code> qui prend en paramètre un champ de formulaire.</p>
<h3 id="avec-du-style">Avec du style</h3>
<p>Rendons notre page d’authentification un peu plus sympa à l’aide d’une feuille de style <code>login.css</code></p>
<pre class=" language-css"><code class="prism  language-css"><span class="token selector">body </span><span class="token punctuation">{</span>
  <span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span>
  <span class="token property">padding-bottom</span><span class="token punctuation">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode">#eee</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector"><span class="token class">.form-signin</span> </span><span class="token punctuation">{</span>
  <span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">330</span>px<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">15</span>px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector"><span class="token class">.form-signin</span> <span class="token class">.form-signin-heading</span> </span><span class="token punctuation">{</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Modifions notre page <code>login.html</code></p>
<pre class=" language-html"><code class="prism  language-html">{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}{{ title }}{% endblock %}
{% block styles %}
{{ super() }}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span>
      <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{ url_for(<span class="token punctuation">'</span>static<span class="token punctuation">'</span>, filename=<span class="token punctuation">'</span>login.css<span class="token punctuation">'</span>) }}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
{% endblock %}
{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form form-signin<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-signin-heading<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Connexion<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
            {{ form.hidden_tag() }}
            {{ wtf.form_errors(form, hiddens="only") }}
            {{ wtf.form_field(form.username) }}
            {{ wtf.form_field(form.password) }}
            {{ wtf.form_field(form.submit) }}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<h2 id="navbar">Navbar</h2>
<p>Ajoutons une navbar à notre page <code>home.html</code> à l’aide du bloc <code>navbar</code><br>
Le code HTML de la navbar provient de la documentation de Bootstrap</p>
<pre class=" language-html"><code class="prism  language-html">{% extends "bootstrap/base.html" %}
{% block navbar %}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>nav</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar navbar-default navbar-fixed-top<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-header<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>button<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-toggle collapsed<span class="token punctuation">"</span></span> <span class="token attr-name">data-toggle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>collapse<span class="token punctuation">"</span></span> <span class="token attr-name">data-target</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#bs-example-navbar-collapse-1<span class="token punctuation">"</span></span> <span class="token attr-name">aria-expanded</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>sr-only<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Toggle navigation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>icon-bar<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>navbar-brand<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Micro site<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>collapse navbar-collapse<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>bs-example-navbar-collapse-1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nav navbar-nav<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Page A<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Page B<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>nav</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
{% block content %}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">padding-top</span><span class="token punctuation">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Home page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
{% endblock %}
</code></pre>
<h1 id="structure-de-code-1">9 - Structure de code</h1>
<p>Avant d’aller plus loin, nous allons aborder quelques bonnes pratiques pour rendre notre code modulable</p>
<h2 id="fichier-de-configuration">Fichier de configuration</h2>
<p>Jusqu’à présent nous avons défini nos paramètres en dur dans notre package <code>app</code>, mais nous pouvons stocker la configuration dans un fichier Python et le fournir à Flask pour le réaliser la configuration.</p>
<p>Créons un fichier <code>config.py</code> à la racine de notre projet :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os

basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    SECRET_KEY <span class="token operator">=</span> <span class="token string">'my_secret_key'</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'app.db'</span><span class="token punctuation">)</span>
    SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre>
<p>Dans notre fichier <code>__init__.py</code> nous pouvons maintenant fournir l’objet <code>Config</code> comme configuration de l’application ce qui nous fait gagner un nombre de lignes non négligeable.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager
<span class="token keyword">from</span> flask_bootstrap <span class="token keyword">import</span> Bootstrap
<span class="token keyword">from</span> config <span class="token keyword">import</span> Config

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
</code></pre>
<p>Cette approche nous permet par exemple de faire de l’héritage de configuration, prenons l’exemple d’une configuration par défaut, d’une configuration pour le développement et une configuration pour la production.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os

basedir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span><span class="token punctuation">:</span>
    SECRET_KEY <span class="token operator">=</span> <span class="token string">'my_secret_key'</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'app.db'</span><span class="token punctuation">)</span>
    SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">False</span>

<span class="token keyword">class</span> <span class="token class-name">DevelopmentConfig</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'dev.db'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ProductionConfig</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span><span class="token punctuation">:</span>
    SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> <span class="token string">'sqlite:///'</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>basedir<span class="token punctuation">,</span> <span class="token string">'prod.db'</span><span class="token punctuation">)</span>

config <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> DevelopmentConfig<span class="token punctuation">,</span>
    <span class="token string">'dev'</span><span class="token punctuation">:</span> DevelopmentConfig<span class="token punctuation">,</span>
    <span class="token string">'prod'</span><span class="token punctuation">:</span> ProductionConfig
<span class="token punctuation">}</span>
</code></pre>
<p><code>config</code> est un dictionnaire qui nous permet de choisir une configuration à partir d’une clé.</p>
<p>Cette approche nous permet de rendre notre application encore plus paramétrable.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager
<span class="token keyword">from</span> flask_bootstrap <span class="token keyword">import</span> Bootstrap
<span class="token keyword">from</span> config <span class="token keyword">import</span> config

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">'dev'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<h2 id="usine-à-application">Usine à application</h2>
<p>Afin de rendre notre application encore plus paramétrable, nous pouvons créer une fonction qui va s’occuper de créer notre application et nous retourner l’objet représentant notre application.</p>
<p>Cette approche pose plusieurs problèmes, prenons le cas de SQLAlchemy :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> config <span class="token keyword">import</span> config

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app
</code></pre>
<p>L’objet <code>db</code> est encapsulé dans la fonction <code>create_app</code> hors nous en avons besoin dans notre fichier <code>models.py</code>.</p>
<p>Pour répondre à ce problème, les extensions Flask possèdent une méthode <code>init_app</code> qui prend en paramètre une application Flask afin d’ajouter l’extension à l’application.</p>
<p>Créons un fichier <code>extensions.py</code> dans notre dossier <code>app</code> qui contient l’ensemble de nos extensions.</p>
<p>Fichier <code>app/extentions.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> LoginManager
<span class="token keyword">from</span> flask_bootstrap <span class="token keyword">import</span> Bootstrap

db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span><span class="token punctuation">)</span>
login <span class="token operator">=</span> LoginManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
bootstrap <span class="token operator">=</span> Bootstrap<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Modifions maintenant notre fichier <code>__init__.py</code> pour initialiser les extensions :</p>
<p>Fichier <code>app/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> config <span class="token keyword">import</span> config
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db<span class="token punctuation">,</span> login<span class="token punctuation">,</span> bootstrap

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    extensions<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app

<span class="token keyword">def</span> <span class="token function">extensions</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    login<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    bootstrap<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre>
<p>Maintenant, modifions l’import des extensions dans le fichier <code>models.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash
<span class="token keyword">from</span> flask_login <span class="token keyword">import</span> UserMixin
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db<span class="token punctuation">,</span> login

@login<span class="token punctuation">.</span>user_loader
<span class="token keyword">def</span> <span class="token function">load_user</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
<p>Un autre problème apparait, dans le fichier <code>routes.py</code> nous utilisons le décorateur <code>@app</code> et avec notre usine, l’objet <code>app</code> n’existe plus.</p>
<p>Pour répondre à ce problème, nous allons utiliser les <strong>Blueprint</strong><br>
On peut comparer les blueprint a des packages.</p>
<p>Un blueprint est composé de :</p>
<ul>
<li>Un nom qui doit être unique</li>
<li>Un point de montage unique dans les routes</li>
<li>Une liste de routes</li>
</ul>
<p>Cette approche est très pratique, car nous encapsulons des morceaux entiers d’application dans des objets.</p>
<p>Créons un dossier <code>public</code> dans notre dossier <code>app</code>, et ajoutons un fichier <code>__init__.py</code></p>
<p>Fichier <code>app/public/__init__.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint  
  
  
blueprint <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/'</span><span class="token punctuation">)</span>
</code></pre>
<p>Ce blueprint contiendra l’ensemble des routes accessible au public.<br>
Créons maintenant un fichier <code>routes.py</code> dans le dossier <code>public</code> et utilisons le blueprint à la place de l’application dans les décorateurs.</p>
<p>Profitons-en pour déplacer le fichier <code>forms.py</code> dans le dossier <code>public</code>, il fait partie de la logique des routes du blueprint.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_login <span class="token keyword">import</span> current_user<span class="token punctuation">,</span> login_user<span class="token punctuation">,</span> logout_user<span class="token punctuation">,</span> login_required
<span class="token keyword">from</span> flask <span class="token keyword">import</span> render_template<span class="token punctuation">,</span> redirect<span class="token punctuation">,</span> flash<span class="token punctuation">,</span> request
<span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>urls <span class="token keyword">import</span> url_parse
<span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> blueprint
<span class="token keyword">from</span> <span class="token punctuation">.</span>forms <span class="token keyword">import</span> LoginForm
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> User

@blueprint<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span>
        <span class="token string">'home.html'</span><span class="token punctuation">,</span>
        title<span class="token operator">=</span><span class="token string">'Home'</span><span class="token punctuation">,</span>
        theme<span class="token operator">=</span><span class="token string">'red'</span>
    <span class="token punctuation">)</span>

@blueprint<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/me'</span><span class="token punctuation">)</span>
@login_required
<span class="token keyword">def</span> <span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> current_user<span class="token punctuation">.</span>username

@blueprint<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> current_user<span class="token punctuation">.</span>is_authenticated<span class="token punctuation">:</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
    form <span class="token operator">=</span> LoginForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        user <span class="token operator">=</span> User<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>form<span class="token punctuation">.</span>username<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> user <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token operator">or</span> <span class="token operator">not</span> user<span class="token punctuation">.</span>verify_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
            flash<span class="token punctuation">(</span><span class="token string">'Nom d\'utilisateur ou mot de passe incorrect.'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
        login_user<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        next_page <span class="token operator">=</span> request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'next'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token operator">not</span> next_page <span class="token operator">or</span> url_parse<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span><span class="token punctuation">.</span>netloc <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">:</span>
            next_page <span class="token operator">=</span> <span class="token string">'/'</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span>next_page<span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'login.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Authentification'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>

@blueprint<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/logout'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logout_user<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
</code></pre>
<p>Il faut de nouveau modifier le fichier <code>__init__.py</code> pour inclure nos routes :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint  
  
  
blueprint <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/'</span><span class="token punctuation">)</span>  
  
<span class="token keyword">from</span> <span class="token punctuation">.</span>routes <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre>
<p>Pourquoi importer les routes à la fin du fichier ? En fait c’est pour éviter les inclusions cycliques, essayez de mettre l’import des routes avant la création du blueprint, Python ne va pas apprécier.</p>
<p>Nous devons ensuite importer notre blueprint et l’ajouter à notre application à l’aide de la méthode <code>register_blueprint</code>.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> config <span class="token keyword">import</span> config
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db<span class="token punctuation">,</span> login<span class="token punctuation">,</span> bootstrap

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">from</span> <span class="token punctuation">.</span>public <span class="token keyword">import</span> blueprint <span class="token keyword">as</span> public_blueprint
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>public_blueprint<span class="token punctuation">)</span>
    extensions<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app

<span class="token keyword">def</span> <span class="token function">extensions</span><span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span>
    login<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span>
    bootstrap<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span>
    login<span class="token punctuation">.</span>login_view <span class="token operator">=</span> <span class="token string">'login'</span>
    <span class="token keyword">with</span> flask_app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> User
        db<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>La dernière chose à faire est de modifier le fichier <code>runserver.py</code> pour prendre en compte nos modifications.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> app <span class="token keyword">import</span> create_app

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    
    app <span class="token operator">=</span> create_app<span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span>
    
    HOST <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_HOST'</span><span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        PORT <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'SERVER_PORT'</span><span class="token punctuation">,</span> <span class="token string">'5552'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
        PORT <span class="token operator">=</span> <span class="token number">5552</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>HOST<span class="token punctuation">,</span> PORT<span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token comment"># On Windows</span>
    <span class="token comment">#app.run(HOST, PORT, debug=True, processes=3) # On Linux</span>
    <span class="token comment">#app.run('0.0.0.0', 8000, processes=3) # On docker</span>
</code></pre>
<p>Votre dossier devrait ressemble à ça :</p>
<pre><code>runserver.py
config.py
app
  __init__.py
  models.py
  extensions.py
  templates
    login.html
    home.html
  static
    login.css
  public
    __init__.py
    forms.py
    routes.py
</code></pre>
<p>Cela peut paraitre lourd à mettre en place, mais il permet de rendre le code lisible et maintenable en plus de rendre notre application paramétrable et modulable.</p>
<p>Avec cette approche nous pouvons par exemple activer ou désactiver des morceaux entiers d’application en fonction d’une configuration.</p>
<pre class=" language-python"><code class="prism  language-python">blueprint <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/dev'</span><span class="token punctuation">)</span>
</code></pre>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> config <span class="token keyword">import</span> config
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db<span class="token punctuation">,</span> login<span class="token punctuation">,</span> bootstrap

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">from</span> <span class="token punctuation">.</span>public <span class="token keyword">import</span> blueprint <span class="token keyword">as</span> public_blueprint
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>public_blueprint<span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> config_name <span class="token operator">==</span> <span class="token string">'dev'</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> <span class="token punctuation">.</span>dev <span class="token keyword">import</span> blueprint <span class="token keyword">as</span> dev_blueprint
        app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>dev_blueprint<span class="token punctuation">)</span>
    extensions<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app
</code></pre>
<h1 id="service-rest">10 - Service REST</h1>
<p>L’architecture REST est un ensemble de conventions et de bonnes pratiques pour la création d’application Web via le protocole HTTP.<br>
Dans une architecture REST, les communications sont de type client-serveur et stateless (sans état), c’est- à dire qu’il n’existe pas de session, chaque communication doit contenir l’ensemble des informations nécessaires à la réalisation de l’action.</p>
<h2 id="flask-restplus">Flask RestPlus</h2>
<p>Flask Restplus est une extension de Flask qui permet de créer rapidement des API REST documentées et facilitant les tests.</p>
<p>Elle permet de considérer les routes HTTP sous forme d’objet.</p>
<p>Les routes sont des classes et les méthodes HTTP deviennent des méthodes de classe.<br>
Exemple :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Resource<span class="token punctuation">,</span> Api
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
api <span class="token operator">=</span> Api<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
@api<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">HelloWorld</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'hello'</span><span class="token punctuation">:</span> <span class="token string">'world'</span><span class="token punctuation">}</span>
</code></pre>
<h2 id="swagger">Swagger</h2>
<p>Swagger est une des plus grandes plus valu de l’extension Flask Restplus, Swagger est une documentation interactive de l’API.<br>
En adoptant une structure de code définie, l’extension Flask Restplus est capable de générer la documentation à partir du code et ceux de manière transparente et automatique.</p>
<p>Cette documentation est particulière utile pendant les phases de développement, car elle offre une IHM et une zone de test des fonctions de l’API, de plus il est possible de la désactiver en production.</p>
<h2 id="postman">Postman</h2>
<p>L’extension Flask Restplus nous permet aussi de réaliser un export Postman de nos API.</p>
<p>Postman est un client Web qui permet de réaliser des scénarios de test et de non-régressions.</p>
<h2 id="installation-4">Installation</h2>
<pre><code>pip install flask-restplus
</code></pre>
<p>Il faut ensuite créer un objet <code>Api</code> et lui fournir notre application</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Api
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
api <span class="token operator">=</span> Api<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
</code></pre>
<h2 id="usage-4">Usage</h2>
<p>Flask-Restplus permet d’aborder les URI comme des ressources, ses ressources sont des objets qui héritent de la classe <code>Resource</code> et chaque méthode HTTP est une méthode de classe.</p>
<p>Exemple via Flask :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> methods <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">,</span> <span class="token string">'PUT'</span><span class="token punctuation">,</span> <span class="token string">'DELETE'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"GET Hello"</span>
    
    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"POST Hello"</span>
    
    <span class="token keyword">elif</span> request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">'PUT'</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"PUT Hello"</span>
    
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"DELETE Hello"</span>
</code></pre>
<p>Exemple via Flask-Restplus :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Resource<span class="token punctuation">,</span> Api
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
api <span class="token operator">=</span> Api<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
@api<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">HelloWorld</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'method'</span><span class="token punctuation">:</span> <span class="token string">'GET hello'</span><span class="token punctuation">}</span>
    
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'method'</span><span class="token punctuation">:</span> <span class="token string">'POST hello'</span><span class="token punctuation">}</span>
    
    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'method'</span><span class="token punctuation">:</span> <span class="token string">'PUT hello'</span><span class="token punctuation">}</span>
    <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'method'</span><span class="token punctuation">:</span> <span class="token string">'DELETE hello'</span><span class="token punctuation">}</span>
</code></pre>
<p>Flask-Restplus nous permet de rendre notre code plus lisible et de séparer les logiques.</p>
<h2 id="structure-de-code-2">Structure de code</h2>
<p>Pour réaliser notre API REST, nous allons utiliser l’usine à application, les blueprint et des objets ajoutés par Flask-Restplus.</p>
<p>Commençons par créer une nouvelle application, nous pouvons copier-coller les fichiers <code>runserver.py</code> et <code>config.py</code><br>
Ensuite ,créons cette arborescence  :</p>
<pre><code>runserver.py
config.py
app
  __init__.py
  models.py
  extensions.py
  api
    __init__.py
    endpoints
      __init__.py
    serializers
      __init__.py
</code></pre>
<p><code>runserver.py</code> et <code>config.py</code> ne changent pas.</p>
<p>Comme précédemment l’ensemble de notre application est dans le dossier <code>app</code><br>
Le dossier <code>api</code> est un <code>blueprint</code> qui contient notre API.</p>
<p>Le dossier <code>endpoints</code> contiendra tous nos <code>namespaces</code> tandis que le dossier <code>serializers</code> contiendra les modèles de données attendues et retournées par notre API.</p>
<p>On peut assimiler un <code>namespace</code> à un point de montage pour nos ressources.</p>
<div class="mermaid"><svg xmlns="http://www.w3.org/2000/svg" id="mermaid-svg-VbiQZjRpmL7ob5pJ" width="100%" style="max-width: 675.96875px;" viewBox="0 0 675.96875 393"><g transform="translate(-12, -12)"><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath" style="opacity: 1;"><path class="path" d="M123.88089139344262,203L194.03125,117L219.03125,117" marker-end="url(#arrowhead53)" style="fill:none"></path><defs><marker id="arrowhead53" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M169.03125,239L194.03125,239L219.03125,239" marker-end="url(#arrowhead54)" style="fill:none"></path><defs><marker id="arrowhead54" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M123.88089139344262,275L194.03125,361L219.390625,361" marker-end="url(#arrowhead55)" style="fill:none"></path><defs><marker id="arrowhead55" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M400.3053278688525,81L453.46875,56L478.46875,56" marker-end="url(#arrowhead56)" style="fill:none"></path><defs><marker id="arrowhead56" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath" style="opacity: 1;"><path class="path" d="M400.3053278688525,153L453.46875,178L478.8125,178" marker-end="url(#arrowhead57)" style="fill:none"></path><defs><marker id="arrowhead57" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g class="node" id="A" transform="translate(94.515625,239)" style="opacity: 1;"><rect rx="0" ry="0" x="-74.515625" y="-36" width="149.03125" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-64.515625,-26)"><foreignObject width="129.03125" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Blueprint</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="B" transform="translate(323.75,117)"><rect rx="0" ry="0" x="-104.71875" y="-36" width="209.4375" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-94.71875,-26)"><foreignObject width="189.4375" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Namespace 1</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="C" transform="translate(323.75,239)"><rect rx="0" ry="0" x="-104.71875" y="-36" width="209.4375" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-94.71875,-26)"><foreignObject width="189.4375" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Namespace 2</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="D" transform="translate(323.75,361)"><rect rx="0" ry="0" x="-104.359375" y="-36" width="208.71875" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-94.359375,-26)"><foreignObject width="188.71875" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Namespace n</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="E" transform="translate(579.21875,56)"><rect rx="0" ry="0" x="-100.75" y="-36" width="201.5" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-90.75,-26)"><foreignObject width="181.5" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Resource 1.1</div></foreignObject></g></g></g><g class="node" style="opacity: 1;" id="F" transform="translate(579.21875,178)"><rect rx="0" ry="0" x="-100.40625" y="-36" width="200.8125" height="72"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-90.40625,-26)"><foreignObject width="180.8125" height="52"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Resource 1.n</div></foreignObject></g></g></g></g></g></g></svg></div>
<p>Commençons par le fichier <code>__init__.py</code> du dossier <code>api</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Api

blueprint <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/api/v1'</span><span class="token punctuation">)</span>
api <span class="token operator">=</span> Api<span class="token punctuation">(</span>blueprint<span class="token punctuation">,</span>
          title<span class="token operator">=</span><span class="token string">'Micro service'</span><span class="token punctuation">,</span>
          version<span class="token operator">=</span><span class="token string">'0.1'</span><span class="token punctuation">,</span>
          description<span class="token operator">=</span><span class="token string">'Python micro service'</span><span class="token punctuation">,</span>
          doc<span class="token operator">=</span><span class="token string">'/'</span>
          <span class="token punctuation">)</span>
</code></pre>
<p>L’usine à application nous empêche d’initialiser <code>API</code> avec l’objet <code>app</code>, mais nous pouvons utiliser un <code>blueprint</code> que l’usine importera.<br>
Nos API deviennent donc modulaires.</p>
<p>Nous pouvons voir que l’objet <code>API</code> accepte beaucoup de paramètres, ils peuvent sembler optionnels, mais il offre 2 choses :</p>
<ul>
<li>Une documentation sommaire de ce que fait cette API</li>
<li>Les paramètres sont utilisés pour générer la documentation Swagger</li>
</ul>
<p>Ajoutons un fichier <code>extensions.py</code> dans notre dossier <code>app</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy  
  
  
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Ajoutons le modèle vue précédemment dans un fichier <code>models.py</code> dans le dossier <code>app</code> :</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db

<span class="token keyword">class</span> <span class="token class-name">Topic</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    messages <span class="token operator">=</span> db<span class="token punctuation">.</span>relationship<span class="token punctuation">(</span><span class="token string">'Message'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'topic'</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">'dynamic'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    ts <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>utcnow<span class="token punctuation">)</span>
    content <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    topic_id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> db<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">'topic.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
</code></pre>
<p>et mettons en place notre usine dans le fichier <code>__init__.py</code> du dossier <code>app</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> config <span class="token keyword">import</span> config
<span class="token keyword">from</span> <span class="token punctuation">.</span>extensions <span class="token keyword">import</span> db

<span class="token keyword">def</span> <span class="token function">create_app</span><span class="token punctuation">(</span>config_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span>config<span class="token punctuation">[</span>config_name<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">from</span> <span class="token punctuation">.</span>api <span class="token keyword">import</span> blueprint <span class="token keyword">as</span> api_blueprint
    app<span class="token punctuation">.</span>register_blueprint<span class="token punctuation">(</span>api_blueprint<span class="token punctuation">)</span>
    extensions<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token keyword">return</span> app

<span class="token keyword">def</span> <span class="token function">extensions</span><span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span><span class="token punctuation">:</span>
    db<span class="token punctuation">.</span>init_app<span class="token punctuation">(</span>flask_app<span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> flask_app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> <span class="token punctuation">.</span>models <span class="token keyword">import</span> Topic<span class="token punctuation">,</span> Message
        
        db<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Notre usine est une copie de l’usine de notre première application, dans l’usine nous traitons uniquement des <code>blueprint</code>.</p>
<p>C’est très pratique, car cela veut dire que dans une même application, on peut monter un <code>blueprint</code> contenant une API et un autre contenant un une IHM Web.</p>
<h2 id="serializers">Serializers</h2>
<p>Les <code>serializers</code> sont des modèles de données que l’API peut retourner ou peut attendre.</p>
<p>Ils ne sont pas obligatoires, mais extrêmement pratiques pour 2 raisons :</p>
<ul>
<li>Ils sont utilisés pour générer la documentation Swagger</li>
<li>Ils sont utilisés par Flask-Restplus pour faire de la validation de données si nous le souhaitons.</li>
</ul>
<p>De base Flask-Restplus n’effectue pas la validation des données, il faut pour cela ajouter le paramètre <code>RESTPLUS_VALIDATE = True</code> à notre fichier <code>config.py</code></p>
<p>Créons un fichier <code>topics.py</code> dans le dossier <code>serializers</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> fields
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> api

topic_post_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Topic POST model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>Un modèle est composé de :</p>
<ul>
<li>Un nom unique parmi tous les modèles de l’API</li>
<li>Un dictionnaire des champs du modèle</li>
</ul>
<p>Chaque champ possède un type est il est possible de définir des règles de validation tels que <code>min_length</code>, <code>max_length</code>.</p>
<p>Les règles de validation dépendent du type du champ.<br>
Ici nous avons créé un modèle que nous utiliserons lors de l’ajout de topics.</p>
<p>Continuons notre fichier <code>topics.py</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> fields
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">import</span> api

topic_post_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Topic POST model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
topic_put_model <span class="token operator">=</span> api<span class="token punctuation">.</span>inherit<span class="token punctuation">(</span><span class="token string">'Topic PUT model'</span><span class="token punctuation">,</span> topic_post_model<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
topic_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Topic model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'id'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>Integer<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic unique ID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>String<span class="token punctuation">(</span>required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
topic_container_model <span class="token operator">=</span> api<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token string">'Topic container model'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'topics'</span><span class="token punctuation">:</span> fields<span class="token punctuation">.</span>List<span class="token punctuation">(</span>fields<span class="token punctuation">.</span>Nested<span class="token punctuation">(</span>topic_model<span class="token punctuation">)</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic list'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p><code>api.inherit</code> permet de faire de l’héritage de modèle, ici l’héritage sert uniquement à donner un nom différent à notre modèle, ce n’est pas obligatoire, mais cela sera plus propre dans Swagger.</p>
<p><code>fields.List</code> permet de définir une liste dans notre modèle, il est nécessaire de spécifier le type de champ contenu dans la liste.</p>
<p><code>fields.Nested</code> permet d’utiliser un autre modèle dans notre modèle, c’est très pratique dans le cas des listes ou d’objets composés.</p>
<h2 id="endpoints">Endpoints</h2>
<p>Les endpoints contiennent nos <code>namespace</code> qui contiennent nos ressources.</p>
<p>Créons un fichier <code>topics.py</code> dans le dossier <code>endpoints</code>.</p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> request<span class="token punctuation">,</span> g<span class="token punctuation">,</span> current_app
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Namespace<span class="token punctuation">,</span> Resource<span class="token punctuation">,</span> abort
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>serializers<span class="token punctuation">.</span>topics <span class="token keyword">import</span> topic_post_model<span class="token punctuation">,</span> topic_put_model<span class="token punctuation">,</span> topic_container_model<span class="token punctuation">,</span> topic_model
<span class="token keyword">from</span> app<span class="token punctuation">.</span>models <span class="token keyword">import</span> Topic

ns <span class="token operator">=</span> Namespace<span class="token punctuation">(</span><span class="token string">'topics'</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">'Topic related operation'</span><span class="token punctuation">)</span>

<span class="token comment"># ================================================================================================</span>
<span class="token comment"># ENDPOINTS</span>
<span class="token comment"># ================================================================================================</span>
<span class="token comment">#</span>
<span class="token comment">#   API topics endpoints</span>
<span class="token comment">#</span>
<span class="token comment"># ================================================================================================</span>

@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">TopicCollection</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>marshal_with<span class="token punctuation">(</span>topic_container_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Return topic list
        """</span>
        
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'topics'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre>
<p>Ici nous avons créer une ressource accessible à l’aide de l’URI <code>&lt;blueprint&gt;/topics/</code> en utilisant la méthode GET</p>
<p>A l’aide du décorateur <code>@ns.marshal_with</code> nous indiquons que Flask-Restplus doit formater nos données avec le modèle <code>topic_container_model</code></p>
<p>Modifions notre fichier <code>__init__.py</code> du dossier <code>api</code> afin de réaliser l’import de notre <code>namespace</code></p>
<pre class=" language-python"><code class="prism  language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Blueprint
<span class="token keyword">from</span> flask_restplus <span class="token keyword">import</span> Api

blueprint <span class="token operator">=</span> Blueprint<span class="token punctuation">(</span><span class="token string">'api'</span><span class="token punctuation">,</span> __name__<span class="token punctuation">,</span> url_prefix<span class="token operator">=</span><span class="token string">'/api/v1'</span><span class="token punctuation">)</span>
api <span class="token operator">=</span> Api<span class="token punctuation">(</span>blueprint<span class="token punctuation">,</span>
          title<span class="token operator">=</span><span class="token string">'Micro service'</span><span class="token punctuation">,</span>
          version<span class="token operator">=</span><span class="token string">'0.1'</span><span class="token punctuation">,</span>
          description<span class="token operator">=</span><span class="token string">'Python micro service'</span><span class="token punctuation">,</span>
          doc<span class="token operator">=</span><span class="token string">'/'</span>
          <span class="token punctuation">)</span>
<span class="token keyword">from</span> <span class="token punctuation">.</span>endpoints<span class="token punctuation">.</span>topics <span class="token keyword">import</span> ns <span class="token keyword">as</span> topics_namespace
api<span class="token punctuation">.</span>add_namespace<span class="token punctuation">(</span>topics_namespace<span class="token punctuation">)</span>
</code></pre>
<p>Nous pouvons maintenant accéder à notre API à l’adresse : <a href="http://localhost:5552/api/v1/">http://localhost:5552/api/v1/</a></p>
<p>Continuons notre fichier <code>topics.py</code> avec l’ajout d’une méthode <code>post</code> qui va nous permettre d’ajouter un topic :</p>
<pre class=" language-python"><code class="prism  language-python">@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">TopicCollection</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @ns<span class="token punctuation">.</span>marshal_with<span class="token punctuation">(</span>topic_container_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Return topic list
        """</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'topics'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    @ns<span class="token punctuation">.</span>marshal_with<span class="token punctuation">(</span>topic_model<span class="token punctuation">)</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>topic_post_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Add topic
        """</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        <span class="token keyword">if</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token operator">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'Name already exist'</span><span class="token punctuation">)</span>
        t <span class="token operator">=</span> Topic<span class="token punctuation">(</span>name<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> t
</code></pre>
<p><code>@ns.expect</code> permet d’indiquer que la ressource attend des données respectant le modèle <code>topic_post_model</code>, les données sont attendues au format JSON.</p>
<p><code>request</code> possède un attribut <code>json</code> qui nous permet de récupérer les informations transmises par l’utilisateur, <code>request.json</code> est un dictionnaire.</p>
<p>Ensuite nous vérifions si le topic existe déjà ou non, si c’est le cas nous retournons une erreur à l’utilisateur.</p>
<p><code>abort</code> attend un code HTTP et un message d’erreur à retourner à l’utilisateur.</p>
<p>Pour finir, nous retournons le topic que nous avons créé.<br>
Continuons notre fichier <code>topics.py</code>, et ajoutons l’accès, la modification et la suppression d’un topic :</p>
<pre class=" language-python"><code class="prism  language-python">@ns<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/&lt;id&gt;'</span><span class="token punctuation">)</span>
@ns<span class="token punctuation">.</span>response<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Topic not found.'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">TopicItem</span><span class="token punctuation">(</span>Resource<span class="token punctuation">)</span><span class="token punctuation">:</span>
    
    @ns<span class="token punctuation">.</span>marshal_with<span class="token punctuation">(</span>topic_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Get topic
        """</span>
        <span class="token keyword">return</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get_or_404<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
    
    @ns<span class="token punctuation">.</span>marshal_with<span class="token punctuation">(</span>topic_model<span class="token punctuation">)</span>
    @ns<span class="token punctuation">.</span>expect<span class="token punctuation">(</span>topic_put_model<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">put</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Update topic
        """</span>
        t <span class="token operator">=</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get_or_404<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> request<span class="token punctuation">.</span>json
        
        ft <span class="token operator">=</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>name<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> ft<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">!=</span> t<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">:</span>
            abort<span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> error<span class="token operator">=</span><span class="token string">'Name already exist.'</span><span class="token punctuation">)</span>
            
        t<span class="token punctuation">.</span>name <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span>
        
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> t
    
    @ns<span class="token punctuation">.</span>response<span class="token punctuation">(</span><span class="token number">204</span><span class="token punctuation">,</span> <span class="token string">'Topic successfully deleted.'</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Delete topic
        """</span>
        t <span class="token operator">=</span> Topic<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get_or_404<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span>
        
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
        db<span class="token punctuation">.</span>session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> <span class="token string">'Topic successfully deleted.'</span><span class="token punctuation">,</span> <span class="token number">204</span>
</code></pre>
<p>Flask-SQLAlchemy propose une méthode <code>get_or_404</code> qui permet de retourner automatique un 404 si une ressource n’existe pas.<br>
Nous avons maintenant un micro service simplifié de gestion de topics.</p>

    </div>
  </div>
</body>

</html>
